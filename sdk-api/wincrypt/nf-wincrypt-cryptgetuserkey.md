# CryptGetUserKey function

## Description

**Important** This API is deprecated. New and existing software should start using [Cryptography Next Generation APIs.](https://learn.microsoft.com/windows/desktop/SecCNG/cng-portal) Microsoft may remove this API in future releases.

The **CryptGetUserKey** function retrieves a handle of one of a user's two [public/private key pairs](https://learn.microsoft.com/windows/desktop/SecGloss/p-gly). This function is used only by the owner of the public/private key pairs and only when the handle of a [cryptographic service provider](https://learn.microsoft.com/windows/desktop/SecGloss/c-gly) (CSP) and its associated [key container](https://learn.microsoft.com/windows/desktop/SecGloss/k-gly) is available. If the CSP handle is not available and the user's certificate is, use
[CryptAcquireCertificatePrivateKey](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptacquirecertificateprivatekey).

## Parameters

### `hProv` [in]

**HCRYPTPROV** handle of a [cryptographic service provider](https://learn.microsoft.com/windows/desktop/SecGloss/c-gly) (CSP) created by a call to
[CryptAcquireContext](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptacquirecontexta).

### `dwKeySpec` [in]

Identifies the private key to use from the key container. It can be AT_KEYEXCHANGE or AT_SIGNATURE.

Additionally, some providers allow access to other user-specific keys through this function. For details, see the documentation on the specific provider.

### `phUserKey` [out]

A pointer to the
[HCRYPTKEY](https://learn.microsoft.com/windows/desktop/SecCrypto/hcryptkey) handle of the retrieved keys. When you have finished using the key, delete the handle by calling the [CryptDestroyKey](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptdestroykey) function.

## Return value

If the function succeeds, the return value is nonzero (TRUE).

If the function fails, the return value is zero (FALSE). For extended error information, call
[GetLastError](https://learn.microsoft.com/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror).

The error codes prefaced by "NTE" are generated by the particular CSP being used. Some possible error codes follow.

| Return code | Description |
| --- | --- |
| **ERROR_INVALID_HANDLE** | One of the parameters specifies a handle that is not valid. |
| **ERROR_INVALID_PARAMETER** | One of the parameters contains a value that is not valid. This is most often a pointer that is not valid. |
| **NTE_BAD_KEY** | The *dwKeySpec* parameter contains a value that is not valid. |
| **NTE_BAD_UID** | The *hProv* parameter does not contain a valid context handle. |
| **NTE_NO_KEY** | The key requested by the *dwKeySpec* parameter does not exist. |

## See also

[CryptAcquireContext](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptacquirecontexta)

[CryptDestroyKey](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptdestroykey)

[CryptGenKey](https://learn.microsoft.com/windows/desktop/api/wincrypt/nf-wincrypt-cryptgenkey)

[Key Generation and Exchange Functions](https://learn.microsoft.com/windows/desktop/SecCrypto/cryptography-functions)