# TraceMessage function

## Description

A
[RegisterTraceGuids](https://learn.microsoft.com/windows/win32/api/evntrace/nf-evntrace-registertraceguidsa)-based
("Classic") event provider uses the **TraceMessage** function to send a
message-based (TMF-based WPP) event to an event tracing session.

## Parameters

### `LoggerHandle` [in]

Handle to the event tracing session that records the event. The provider obtains
the handle when it calls the
[GetTraceLoggerHandle](https://learn.microsoft.com/windows/desktop/ETW/gettraceloggerhandle) function in
its [ControlCallback](https://learn.microsoft.com/windows/desktop/ETW/controlcallback) implementation.

### `MessageFlags` [in]

Adds additional information to the beginning of the provider-specific data
section of the event. The provider-specific data section of the event will
contain data only for those flags that are set. The variable list of argument
data will follow this information. This parameter can be one or more of the
following values.

- **TRACE_MESSAGE_COMPONENTID**

 Include the component identifier in the message. The _MessageGuid_ parameter
contains the component identifier.

- **TRACE_MESSAGE_GUID**

 Include the event trace class GUID in the message. The _MessageGuid_ parameter
contains the event trace class GUID.

- **TRACE_MESSAGE_SEQUENCE**

 Include a sequence number in the message. The sequence number starts at one.
To use this flag, the controller must have set the
  **EVENT_TRACE_USE_GLOBAL_SEQUENCE** or **EVENT_TRACE_USE_LOCAL_SEQUENCE** log
file mode when creating the session.

- **TRACE_MESSAGE_SYSTEMINFO**

 Include the thread identifier and process identifier in the message.

- **TRACE_MESSAGE_TIMESTAMP**

 Include a time stamp in the message.

**TRACE_MESSAGE_COMPONENTID** and **TRACE_MESSAGE_GUID** are mutually exclusive.

The information is included in the event data in the following order:

- Sequence number
- Event trace class GUID (or component identifier)
- Time stamp
- Thread identifier
- Process identifier

### `MessageGuid` [in]

Class GUID or component ID that identifies the message. Depends if
_MessageFlags_ contains the **TRACE_MESSAGE_COMPONENTID** or
**TRACE_MESSAGE_GUID** flag.

### `MessageNumber` [in]

Number that uniquely identifies each occurrence of the message. You must define
the value specified for this parameter; the value should be meaningful to the
application.

### `...`

A list of variable arguments to be appended to the message. Use this list to
specify your provider-specific event data. The list must be composed of pairs of
arguments as follows.

- **PVOID**: Pointer to the argument data.
- **size_t**: The size of the argument data, in bytes.

Terminate the list using an argument pair consisting of a pointer to **NULL**
and zero.

The caller must ensure that the sum of the sizes of the arguments + 72 does not
exceed the size of the event tracing session's buffer.

## Return value

If the function succeeds, the return value is ERROR_SUCCESS.

If the function fails, the return value is one of the
[system error codes](https://learn.microsoft.com/windows/win32/debug/system-error-codes). The following
are some common errors and their causes.

- **ERROR_INVALID_HANDLE**

 Either the _LoggerHandle_ is **NULL** or specifies the NT Kernel Logger
session handle.

- **ERROR_NOT_ENOUGH_MEMORY**

 The session ran out of free buffers to write to. This can occur during high
event rates because the disk subsystem is overloaded or the number of buffers
is too small. Rather than blocking until more buffers become available,
[TraceMessage](https://learn.microsoft.com/windows/desktop/ETW/tracemessage) discards the event.

  **Windows 2000 and Windows XP:** Not supported.

- **ERROR_OUTOFMEMORY**

 The event is discarded because, although the buffer pool has not reached its
maximum size, there is insufficient available memory to allocate an additional
buffer and there is no buffer available to receive the event.

- **ERROR_INVALID_PARAMETER**

 _MessageFlags_ contains a value that is not valid.

- **ERROR_MORE_DATA**

 Data from a single event cannot span multiple buffers. A trace event is
limited to the size of the event tracing session's buffer minus the size of
the [EVENT_TRACE_HEADER](https://learn.microsoft.com/windows/desktop/ETW/event-trace-header) structure.

## Remarks

TMF-based WPP providers call this function.

> [!Note]
> Most developers will not call this function directly. WPP providers
> use wrapper functions generated by tracewpp.exe instead of calling ETW APIs.

If you need to access message tracing functionality from a wrapper function,
call the [TraceMessageVa](https://learn.microsoft.com/windows/desktop/ETW/tracemessageva) version of this
function.

Consumers will have to use the
[EventCallback](https://learn.microsoft.com/windows/desktop/ETW/eventcallback) callback to receive and
process the events if the _MessageFlags_ parameter does not contain the
TRACE_MESSAGE_GUID flag. If you do not specify the TRACE_MESSAGE_GUID flag, the
consumer will not be able to use the
[EventClassCallback](https://learn.microsoft.com/windows/desktop/ETW/eventclasscallback) because the
**Header.Guid** member of the [EVENT_TRACE](https://learn.microsoft.com/windows/desktop/ETW/event-trace)
structure will not contain the event trace class GUID.

Note that the members of the [EVENT_TRACE](https://learn.microsoft.com/windows/desktop/ETW/event-trace) and
[EVENT_TRACE_HEADER](https://learn.microsoft.com/windows/desktop/ETW/event-trace-header) structures that
correspond to the _MessageFlags_ flags are set only if the corresponding flag is
specified. For example, the **ThreadId** and **ProcessId** members of
**EVENT_TRACE_HEADER** are populated only if you specify the
TRACE_MESSAGE_SYSTEMINFO flag.

## See also

[TraceEvent](https://learn.microsoft.com/windows/desktop/ETW/traceevent)

[TraceEventInstance](https://learn.microsoft.com/windows/desktop/ETW/traceeventinstance)

[TraceMessageVa](https://learn.microsoft.com/windows/desktop/ETW/tracemessageva)